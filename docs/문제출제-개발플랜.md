# 📝 문제 출제 기능 - 개발 플랜

## 📋 개요

지문 선택 → 문제 유형 선택 → AI 생성 → 미리보기 → 등록까지의 전체 문제 출제 플로우 구현

---

## 🔄 출제 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│  1️⃣ 범위지정        2️⃣ 유형선택       3️⃣ 출제시작              │
│  (지문 선택)        (문제 유형)       (버튼 클릭)               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4️⃣ 블록 검증/생성                                              │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ 캐시 있음?       │ NO │   AI 호출       │                    │
│  │ (block_instances)├───►│   새로 생성     │                    │
│  └────────┬────────┘    └────────┬────────┘                    │
│           │ YES                  │                              │
│           └──────────┬───────────┘                              │
│                      ▼                                          │
│           block_instances 저장 (캐시)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5️⃣ 미리보기                                                    │
│  - 지문별 선택적 확인                                            │
│  - 레이아웃 적용된 형태                                          │
│  - 아직 generated_questions에 미저장                             │
│  - 성공/실패 표시                                                │
│  - 등록할 항목 선택 (체크박스)                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6️⃣ 등록                                                        │
│  - 선택한 항목만 generated_questions에 저장                       │
│  - 같은 지문+유형 조합은 덮어쓰기                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  7️⃣ 완료                                                        │
│  - 성공/실패 수 표시                                             │
│  - 출력물 생성으로 이동 (선택)                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📌 정책 결정사항

### 데이터 관리

| 항목 | 정책 |
|------|------|
| 지문 수정 | 없음. 삭제 시 종속 문제 전체 삭제 |
| 재출제 | 같은 지문+유형 → 덮어쓰기 (최신만 유지) |
| 레이아웃 | 데이터와 분리. 출력 시 최신 layout_config 적용 |

### 에러 처리

| 항목 | 정책 |
|------|------|
| 필수필드 누락 | 검증 → 스킵 → 오류 문제 별도 관리 (향후) |
| API 실패 | 자동 재시도 (최대 2회) → 실패 시 스킵 |
| 부분 실패 | 실패 지문 표시 → 재생성/스킵 선택 |

### 대량 처리

| 항목 | 정책 |
|------|------|
| 처리 방식 | 배치 처리 + 병렬 제한 (동시 3~5개) |
| 진행률 | 실시간 표시 |
| 이탈 시 | 경고 표시. 강제 닫힘 시 캐시 활용 |

### 블록 삭제

| 항목 | 정책 |
|------|------|
| 삭제 절차 | 영향 범위 (유형 N개, 문제 M개) 통보 → 확인 후 삭제 |
| 관련 문제 | 관리자가 수동 삭제 |

---

## 🏗️ 구현 범위

### Phase 1: 핵심 기능 (필수)

| # | 기능 | 설명 | 우선순위 |
|---|------|------|----------|
| 1-1 | 출제 UI 레이아웃 | 문제출제 탭 메인 화면 구성 | 🔴 |
| 1-2 | 문제 유형 선택 패널 | 유형 목록 + 선택 UI | 🔴 |
| 1-3 | 생성 API 수정 | 미리보기 데이터 반환 (저장 분리) | 🔴 |
| 1-4 | 배치 처리 | 병렬 제한 + 진행률 표시 | 🔴 |
| 1-5 | 필수필드 검증 | choices, answer 등 검증 | 🔴 |
| 1-6 | 미리보기 화면 | 지문별 결과 표시 | 🔴 |
| 1-7 | 부분 등록 | 선택 항목만 저장 | 🔴 |
| 1-8 | 덮어쓰기 로직 | 같은 지문+유형 upsert | 🔴 |

### Phase 2: 안정성 (권장)

| # | 기능 | 설명 | 우선순위 |
|---|------|------|----------|
| 2-1 | 테스트 모드 | 1개 지문만 먼저 테스트 | ⭐ |
| 2-2 | 자동 재시도 | 실패 시 최대 2회 재시도 | ⭐ |
| 2-3 | 에러 분류 | AI오류/네트워크/필드누락 분류 | ⭐ |
| 2-4 | 페이지 이탈 경고 | beforeunload 이벤트 | ⭐ |
| 2-5 | 블록 삭제 확인 | 영향 범위 표시 + 확인 | ⭐ |

### Phase 3: 향후 구현

| # | 기능 | 설명 |
|---|------|------|
| 3-1 | 오류 문제 관리 | 실패 건 별도 관리 화면 |
| 3-2 | 출제 이력/로그 | 누가/언제/성공률 기록 |
| 3-3 | 출제 프리셋 | 자주 쓰는 조합 저장 |
| 3-4 | 토큰 사용량 분석 | 모델별/유형별 비용 |

---

## 📁 파일 구조

```
src/
├── app/
│   └── api/
│       ├── generate/
│       │   ├── route.ts          # 기존 (수정)
│       │   └── preview/
│       │       └── route.ts      # 미리보기용 (신규)
│       └── generated-questions/
│           └── route.ts          # 등록 API (신규)
│
├── components/
│   └── features/
│       └── generation/
│           ├── index.ts
│           ├── GenerationPanel.tsx      # 메인 출제 패널
│           ├── QuestionTypeSelector.tsx # 유형 선택
│           ├── GenerationProgress.tsx   # 진행률 표시
│           ├── PreviewList.tsx          # 미리보기 목록
│           ├── PreviewItem.tsx          # 개별 미리보기
│           └── GenerationResult.tsx     # 결과 화면
│
└── lib/
    └── generation/
        ├── validator.ts          # 필수필드 검증
        └── batch-processor.ts    # 배치 처리 로직
```

---

## 🔧 API 설계

### POST /api/generate/preview

미리보기용 생성 (DB 저장 없음)

**Request:**
```typescript
{
  passage_ids: string[]
  question_type_id: string
  model?: string
}
```

**Response:**
```typescript
{
  success: boolean
  results: Array<{
    passage_id: string
    passage_name: string
    status: 'success' | 'failed' | 'skipped'
    error?: string
    preview: {
      body: string
      choices?: string[]
      answer?: string
      explanation?: string
    }
    block_instance_id?: string  // 캐시된 블록 ID
  }>
  summary: {
    total: number
    success: number
    failed: number
  }
}
```

### POST /api/generated-questions/register

선택 항목 등록 (덮어쓰기)

**Request:**
```typescript
{
  question_type_id: string
  items: Array<{
    passage_id: string
    block_instance_id: string
  }>
}
```

**Response:**
```typescript
{
  success: boolean
  registered: number
  updated: number  // 덮어쓰기된 수
}
```

---

## 🎨 UI 설계

### 문제출제 탭 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  교재관리 > 문제출제                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐  │
│  │ 📋 문제 유형 선택        │  │ 📄 미리보기 / 결과          │  │
│  │                         │  │                             │  │
│  │ ○ 수능-빈칸추론         │  │  선택된 지문: 5개            │  │
│  │ ○ 수능-주제             │  │  선택된 유형: 빈칸추론       │  │
│  │ ● 수능-제목             │  │                             │  │
│  │ ○ 내신-어법선택         │  │  ┌───────────────────────┐  │  │
│  │ ○ 내신-서술형           │  │  │ 진행률: ████████░░ 80% │  │  │
│  │                         │  │  └───────────────────────┘  │  │
│  │                         │  │                             │  │
│  │ ┌─────────────────────┐ │  │  ☑ 지문1 - ✅ 성공         │  │
│  │ │ [테스트] [출제시작]  │ │  │  ☑ 지문2 - ✅ 성공         │  │
│  │ └─────────────────────┘ │  │  ☐ 지문3 - ❌ 실패         │  │
│  │                         │  │  ☑ 지문4 - ✅ 성공         │  │
│  │                         │  │  ☑ 지문5 - ✅ 성공         │  │
│  │                         │  │                             │  │
│  │                         │  │  [선택 항목 등록] (4개)     │  │
│  └─────────────────────────┘  └─────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 미리보기 상세

```
┌─────────────────────────────────────────────────────────────────┐
│  📄 지문1: Lesson 3 - Technology                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [지문]                                                         │
│  The development of artificial intelligence has _______ ...     │
│                                                                 │
│  [선택지]                                                       │
│  ① transformed the way we live                                 │
│  ② been limited to research labs                               │
│  ③ decreased human productivity                                │
│  ④ replaced all manual work                                    │
│  ⑤ eliminated the need for education                           │
│                                                                 │
│  [정답] ①                                                       │
│                                                                 │
│  [해설]                                                         │
│  인공지능의 발전이 우리의 삶의 방식을 변화시켰다는 내용...        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 필수필드 검증 규칙

```typescript
interface ValidationRules {
  // 공통
  passage: { required: false }  // AI가 수정하면 있고, 아니면 원본 사용
  
  // 문제형
  choices: { 
    required: true,
    type: 'array',
    minLength: 4,
    maxLength: 5
  }
  answer: {
    required: true,
    type: 'number | string',
    validate: (v, choices) => v >= 1 && v <= choices.length
  }
  explanation: { required: false }
  
  // 자습서형
  // choices, answer 불필요
}
```

---

## 🚀 개발 순서

### Week 1: 기본 구조
- [ ] 1-1: 출제 UI 레이아웃 구성
- [ ] 1-2: 문제 유형 선택 패널
- [ ] 1-3: 생성 API 수정 (미리보기 분리)

### Week 2: 핵심 기능
- [ ] 1-4: 배치 처리 + 진행률
- [ ] 1-5: 필수필드 검증
- [ ] 1-6: 미리보기 화면

### Week 3: 완성
- [ ] 1-7: 부분 등록
- [ ] 1-8: 덮어쓰기 로직
- [ ] 2-1~2-5: 안정성 기능

---

## ✅ 체크리스트

### 시작 전 확인
- [ ] block_definitions에 테스트용 블록 1개 이상 생성
- [ ] question_types에 테스트용 유형 1개 이상 생성
- [ ] passages에 테스트용 지문 5개 이상 등록

### 완료 기준
- [ ] 5개 지문 + 1개 유형으로 출제 성공
- [ ] 부분 실패 시 스킵 후 나머지 등록 가능
- [ ] 같은 지문+유형 재출제 시 덮어쓰기 동작
- [ ] 미리보기에서 레이아웃 정상 적용

---

## 📝 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-12-11 | 최초 작성 |


