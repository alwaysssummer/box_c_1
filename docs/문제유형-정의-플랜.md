# 📝 문제 유형 정의 시스템 - 구현 플랜

## 📋 개요

블록(AI 프롬프트) + 레이아웃 + 출력 설정을 조합하여 **재사용 가능한 문제 템플릿**을 만드는 4단계 위자드 시스템

---

## 🏗️ 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        블록 정의                              │
│  (AI 프롬프트 + 출력 필드 정의, 재사용 가능한 템플릿)            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       문제 유형 정의                           │
│  (블록 선택 + 레이아웃 + 출력 뷰 설정)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        문제 생성                              │
│  (지문 선택 → AI 실행 → 결과 저장)                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🧙 4단계 위자드 플로우

### Step 1: 출력 유형 선택

**목적**: 문제형/자습서형 구분으로 후속 단계 필터링

| 출력 유형 | 설명 | Step 2 영향 | Step 4 |
|----------|------|------------|--------|
| **문제형** | 정답/해설 포함 | 문제용 블록만 표시 | ✅ 활성화 |
| **자습서형** | 본문만 (해석, 어휘, 구문) | 자습서용 블록만 표시 | ⏭️ 스킵 |

**저장 필드**: `output_type: "question" | "study_material"`

---

### Step 2: 블록 선택

**목적**: 사용할 AI 블록 1개 선택 (1문제유형 = 1블록 원칙)

**UI 요소**:
- 블록 검색
- 카테고리별 그룹화 (수능형, 내신-지문단위, 내신-문장단위)
- 블록 정보 표시 (이름, 대상 단위, 지문 처리 방식)

**블록에서 자동 상속**:
- `target_unit`: passage / sentence → 문장 분리 여부 결정
- `output_fields`: Step 4 필드 목록 자동 생성

**저장 필드**: `block_id: "uuid"`

---

### Step 3: 레이아웃 설정

**목적**: 출력물의 배치 및 형식 설정

#### 공통 옵션 (모든 블록)

| 옵션 | 값 | 설명 |
|------|---|------|
| 배치 모드 | `free_flow` / `page_fixed` | 자유흐름 / 페이지고정 |
| 단 구성 | `1` / `2` | 1단 / 2단 |
| 페이지당 문제 수 | `number` | 페이지고정 시만 |

#### 묶음 블록 전용 옵션 (choices 필드 존재 시)

| 옵션 | 값 | 설명 |
|------|---|------|
| 선택지 배열 | `horizontal` / `vertical` | 가로 / 세로 |
| 선택지 마커 | `number_circle` / `alpha_circle` / `number_dot` | ①②③ / ⓐⓑⓒ / 1.2.3. |

**동적 UI 로직**:
```typescript
const hasChoices = selectedBlock?.output_fields?.some(f => f.key === 'choices');
// hasChoices가 true일 때만 선택지 옵션 표시
```

**저장 필드**:
```typescript
layout_config: {
  placement_mode: "free_flow" | "page_fixed",
  columns: 1 | 2,
  questions_per_page?: number,
  choice_layout?: "horizontal" | "vertical",
  choice_marker?: "number_circle" | "alpha_circle" | "number_dot"
}
```

---

### Step 4: 출력 뷰 설정 (문제형만)

**목적**: 학생용/정답용/교사용 각각 표시할 필드 선택

**UI**: 블록의 `output_fields`를 기반으로 체크박스 매트릭스 생성

| 필드 | 학생용 | 정답용 | 교사용 |
|------|--------|--------|--------|
| passage | ☑ | ☐ | ☑ |
| choices | ☑ | ☑ | ☑ |
| answer | ☐ | ☑ | ☑ |
| explanation | ☐ | ☐ | ☑ |

**저장 필드**:
```typescript
layout_config: {
  // ...Step 3 값들...
  views: {
    student: ["passage", "choices"],
    answer: ["choices", "answer"],
    teacher: ["passage", "choices", "answer", "explanation"]
  }
}
```

---

## 📊 데이터베이스 스키마

### question_types 테이블

```sql
CREATE TABLE question_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  
  -- Step 1
  output_type VARCHAR(20) NOT NULL, -- 'question' | 'study_material'
  
  -- Step 2
  block_id UUID REFERENCES block_definitions(id),
  
  -- Step 3 + Step 4
  layout_config JSONB DEFAULT '{}',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### layout_config JSON 구조

```typescript
interface LayoutConfig {
  // Step 3: 레이아웃
  placement_mode: "free_flow" | "page_fixed";
  columns: 1 | 2;
  questions_per_page?: number;
  choice_layout?: "horizontal" | "vertical";
  choice_marker?: "number_circle" | "alpha_circle" | "number_dot";
  
  // Step 4: 출력 뷰
  views?: {
    student: string[];
    answer: string[];
    teacher: string[];
  };
}
```

---

## 🔄 단계 간 데이터 흐름

```
Step 1                Step 2                Step 3                Step 4
──────                ──────                ──────                ──────
output_type    ──→    블록 필터링     ──→    레이아웃 옵션   ──→    필드 목록
                           │                    │                    │
                           ▼                    ▼                    ▼
                      block_id            layout_config          views
                           │                    │                    │
                           │     output_fields  │                    │
                           └──────→ 자동상속 ───┴────→ 체크박스 생성 ─┘
```

---

## 📦 블록 유형별 레이아웃 옵션

| 블록 유형 | 판별 기준 | 레이아웃 옵션 |
|----------|----------|--------------|
| **단일 블록** | `output_fields.length === 1` | 기본 옵션만 |
| **묶음 블록** | `output_fields.length > 1` | 기본 + 선택지 옵션 |

---

## 🎯 문제 유형 전체 맵

| 대분류 | 소분류 | 블록 target_unit | 지문 처리 |
|--------|--------|------------------|----------|
| **수능형** | 주제/제목/요지 | passage | 원본 |
| | 빈칸추론/어휘추론 | passage | 수정 |
| | 문장배열/넣기 | passage | 가공 |
| | 요약문 | passage | 별도생성 |
| **내신-지문** | 어법선택/수정 | passage | 원본/수정 |
| | 빈칸형/서술형 | passage | 수정 |
| **내신-문장** | 어구배열 | sentence | 자동분리 |
| | 부분영작/조건영작 | sentence | 자동분리 |
| **자습서** | 해석/어휘/구문 | passage | 원본 |

---

## ✅ 핵심 원칙

| 원칙 | 내용 |
|------|------|
| **1문제유형 = 1블록** | 복수 블록 조합 없음 |
| **페이지고정 = 동일유형** | 한 페이지에 다른 유형 혼합 없음 |
| **문장분리 자동화** | `target_unit: sentence`면 시스템이 자동 처리 |
| **출력뷰 분리** | 학생/정답/교사용 필드 가시성 독립 설정 |

---

## 📁 구현 파일 목록

### API

| 파일 | 설명 |
|------|------|
| `src/app/api/question-types/route.ts` | GET (목록), POST (생성) |
| `src/app/api/question-types/[id]/route.ts` | GET, PUT, DELETE |

### UI 컴포넌트

| 파일 | 설명 |
|------|------|
| `src/components/features/question-type/QuestionTypeList.tsx` | 문제 유형 목록 |
| `src/components/features/question-type/QuestionTypeForm.tsx` | 4단계 위자드 폼 |
| `src/components/features/question-type/index.ts` | 컴포넌트 export |

### 타입 정의

| 파일 | 설명 |
|------|------|
| `src/types/index.ts` | `QuestionType`, `LayoutConfig` 타입 |

---

## 🚀 구현 순서

### Phase 1: 기본 구조
1. [ ] DB 마이그레이션 (question_types 테이블 확인/수정)
2. [ ] 타입 정의 업데이트
3. [ ] API 라우트 구현

### Phase 2: UI 위자드
4. [ ] Step 1 - 출력 유형 선택 UI
5. [ ] Step 2 - 블록 선택 UI
6. [ ] Step 3 - 레이아웃 설정 UI
7. [ ] Step 4 - 출력 뷰 설정 UI

### Phase 3: 통합
8. [ ] 위자드 네비게이션 (이전/다음/저장)
9. [ ] 검증 로직
10. [ ] 목록 페이지 연동

---

## 📝 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-12-11 | 최초 작성 |








