# 📝 문제 출제 기능 - 개발 플랜

## 📋 개요

지문 선택 → 문제 유형 선택 → AI 출제 → 미리보기 → 등록의 전체 플로우를 구현하는 개발 플랜

---

## 🔄 출제 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│  1️⃣ 범위지정                                                    │
│     └─ 트리에서 지문 체크박스 선택                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  2️⃣ 유형선택                                                    │
│     └─ 문제 유형 목록에서 선택                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  3️⃣ 출제시작                                                    │
│     └─ "출제 시작" 버튼 클릭                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  4️⃣ 블록 검증 & 생성                                            │
│     ├─ 기존 캐시 확인 (block_instances)                          │
│     ├─ 미생성 → AI 호출 → 캐시 저장                               │
│     ├─ 기생성 → 캐시 재사용                                       │
│     ├─ 필수필드 검증 → 실패 시 스킵                               │
│     └─ 진행률 표시 (배치 처리)                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  5️⃣ 미리보기                                                    │
│     ├─ 지문별 선택적 확인                                         │
│     ├─ 레이아웃 적용된 형태로 표시                                 │
│     ├─ 성공/실패 상태 표시                                        │
│     └─ ※ 아직 generated_questions에 저장 안됨                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  6️⃣ 등록                                                        │
│     ├─ 부분 등록 가능 (10개 중 5개만 선택)                         │
│     ├─ 같은 지문+유형 → 덮어쓰기                                  │
│     └─ generated_questions에 저장                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  7️⃣ 완료                                                        │
│     └─ 성공/실패 수 표시                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 데이터 구조

### 저장 시점

| 단계 | 저장 대상 | 테이블 |
|------|----------|--------|
| 출제시작 직후 | AI 응답 캐시 | `block_instances` |
| 등록 버튼 클릭 | 최종 문제 | `generated_questions` |

### 테이블 관계

```
block_definitions (프롬프트 템플릿)
        │
        ▼
block_instances (AI 응답 캐시)
        │
        └──────────────────────────────────┐
                                           ▼
passages (지문) ──────────────────► generated_questions (최종 문제)
                                           ▲
question_types (문제 유형 + 레이아웃) ──────┘
```

---

## ⚙️ 비즈니스 규칙

### 1. 지문 관련
- 지문 수정: **없음** (수정 기능 미지원)
- 지문 삭제: 종속된 모든 문제 삭제 후 처음부터 재출제

### 2. 재출제 정책
- 같은 지문 + 같은 유형 재출제 시: **덮어쓰기** (최신 버전만 유지)

### 3. 블록 캐시 정책
- 캐시 재사용 조건: `block_def_id` + `passage_id` + `sentence_index` 일치
- 프롬프트 버전 변경 시: 관리자가 설정에서 수동 재생성

### 4. 에러 처리
- 필수필드 누락: 스킵 처리 → 오류 문제 별도 관리 (향후)
- API 실패: 자동 재시도 (최대 2회) → 실패 시 스킵
- 부분 실패: 실패 지문 재생성/스킵 옵션 제공

### 5. 레이아웃 정책
- 데이터와 레이아웃 분리
- 출력 시점에 `question_types.layout_config` 적용
- 레이아웃 수정 시 자동 반영 (재출제 불필요)

### 6. 블록 삭제 정책
- 삭제 전 영향 범위 통보 (사용 중인 문제 유형/문제 수)
- 확인 후 블록만 삭제
- 관련 문제는 관리자가 수동 삭제

---

## 🔧 구현 상세

### Phase 1: UI 기본 구조 (1일)

#### Task 1-1: 출제 화면 레이아웃
- [ ] `OneClickGeneration.tsx` 리팩토링
- [ ] 좌측: 선택된 지문 목록
- [ ] 우측: 문제 유형 선택 패널
- [ ] 하단: 출제 시작 버튼

#### Task 1-2: 문제 유형 선택 UI
- [ ] 활성화된 문제 유형 목록 표시
- [ ] 그룹별 분류 (수능형, 내신-지문, 내신-문장, 자습서)
- [ ] 선택 시 하이라이트

### Phase 2: 생성 로직 (2일)

#### Task 2-1: 배치 생성 엔진
- [ ] 병렬 처리 (동시 3개)
- [ ] Rate Limiting
- [ ] 자동 재시도 (최대 2회)
- [ ] 진행률 계산

#### Task 2-2: 실시간 진행률 표시
- [ ] 프로그레스바
- [ ] 현재/전체 카운트
- [ ] 예상 완료 시간
- [ ] 성공/실패 실시간 업데이트

#### Task 2-3: 필수필드 검증
- [ ] JSON 파싱 검증
- [ ] 필수필드 존재 확인 (output_fields 기반)
- [ ] 선택지 개수 검증 (choices 있을 때)
- [ ] 정답 범위 검증

### Phase 3: 미리보기 (1일)

#### Task 3-1: 미리보기 화면
- [ ] 지문별 카드 UI
- [ ] 성공/실패 상태 배지
- [ ] 펼치기/접기 토글
- [ ] 체크박스 (등록할 지문 선택)

#### Task 3-2: 레이아웃 적용 렌더링
- [ ] layout_config 기반 렌더링
- [ ] 선택지 마커 적용 (①②③, ⓐⓑⓒ, 1.2.3.)
- [ ] 선택지 배열 적용 (세로/가로)
- [ ] 뷰 분리 (학생용/정답용/교사용 탭)

### Phase 4: 등록 & 완료 (1일)

#### Task 4-1: 부분 등록
- [ ] 선택된 지문만 등록
- [ ] 덮어쓰기 로직 (UPSERT)
- [ ] 등록 결과 반환

#### Task 4-2: 완료 화면
- [ ] 성공/실패 요약
- [ ] 실패한 지문 목록
- [ ] "실패 지문 재출제" 버튼
- [ ] "완료" 버튼

### Phase 5: 안정성 (0.5일)

#### Task 5-1: 페이지 이탈 처리
- [ ] beforeunload 경고
- [ ] 생성 중 상태 플래그

#### Task 5-2: 블록 삭제 시 영향 범위
- [ ] 삭제 전 count 쿼리
- [ ] 경고 다이얼로그
- [ ] 확인 후 삭제

---

## 📁 파일 구조

```
src/
├── components/features/generation/
│   ├── index.ts
│   ├── OneClickGeneration.tsx      # 메인 출제 화면
│   ├── QuestionTypeSelector.tsx    # 문제 유형 선택 패널
│   ├── GenerationProgress.tsx      # 진행률 표시
│   ├── GenerationPreview.tsx       # 미리보기 화면
│   ├── PreviewCard.tsx             # 지문별 미리보기 카드
│   └── GenerationResult.tsx        # 완료 화면
│
├── app/api/
│   ├── generate/
│   │   ├── route.ts                # 기존 생성 API (수정)
│   │   └── batch/route.ts          # 배치 생성 API (신규)
│   └── block-definitions/
│       └── [id]/
│           └── impact/route.ts     # 삭제 영향 범위 API (신규)
│
└── lib/
    ├── ai-block-generator.ts       # 기존 AI 생성 라이브러리
    └── question-renderer.ts        # 레이아웃 렌더링 (신규)
```

---

## 🔌 API 명세

### POST /api/generate/batch

배치 생성 요청

**Request:**
```json
{
  "passage_ids": ["uuid1", "uuid2", ...],
  "question_type_id": "uuid",
  "model": "gemini-2.0-flash"
}
```

**Response (Streaming / SSE):**
```json
{
  "type": "progress",
  "data": {
    "current": 3,
    "total": 10,
    "passage_id": "uuid",
    "status": "success" | "failed",
    "error": "에러 메시지"
  }
}

{
  "type": "complete",
  "data": {
    "results": [...],
    "summary": {
      "total": 10,
      "success": 8,
      "failed": 2
    }
  }
}
```

### GET /api/block-definitions/[id]/impact

블록 삭제 영향 범위 조회

**Response:**
```json
{
  "question_types": [
    { "id": "uuid", "name": "빈칸추론" }
  ],
  "question_type_count": 3,
  "generated_questions_count": 150
}
```

---

## 🧪 테스트 시나리오

### 정상 케이스
1. 5개 지문 + 1개 유형 → 전체 성공
2. 같은 지문 재출제 → 덮어쓰기 확인
3. 10개 중 5개만 선택 등록

### 에러 케이스
1. AI 응답 JSON 파싱 실패 → 스킵
2. 필수필드 누락 → 스킵
3. 부분 실패 (10개 중 3개 실패) → 재생성 옵션

### 경계 케이스
1. 0개 지문 선택 → 버튼 비활성화
2. 100개 지문 대량 생성 → 배치 처리 확인
3. 생성 중 페이지 이탈 → 경고 표시

---

## 📅 일정 (총 5.5일)

| Phase | 내용 | 예상 기간 |
|-------|------|----------|
| Phase 1 | UI 기본 구조 | 1일 |
| Phase 2 | 생성 로직 | 2일 |
| Phase 3 | 미리보기 | 1일 |
| Phase 4 | 등록 & 완료 | 1일 |
| Phase 5 | 안정성 | 0.5일 |

---

## 🔜 향후 개선 (v2)

- [ ] 오류 문제 별도 관리 페이지
- [ ] 출제 이력/로그
- [ ] 출제 프리셋 저장
- [ ] 테스트 모드 (1개 먼저 실행)
- [ ] 품질 검증 (선택지 유사도, 정답 분포)
- [ ] 예약 출제

---

## 📝 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-12-11 | 최초 작성 |
