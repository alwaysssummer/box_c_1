# 📝 문제 출제 기능 - 개발 플랜

## 📋 개요

블록 기반 AI 문제 출제 시스템의 핵심 기능 구현

---

## 🔄 출제 플로우

```
1️⃣ 범위지정 (지문 선택)
        ↓
2️⃣ 유형선택 (문제 유형 선택)
        ↓
3️⃣ 출제시작 클릭
        ↓
4️⃣ 블록 검증 → 미생성은 AI 호출, 기생성은 재사용
   (block_instances에 캐시 저장)
        ↓
5️⃣ 미리보기 (지문별 선택적 확인)
   - 레이아웃 적용된 형태로 표시
   - 부분 선택 가능
        ↓
6️⃣ 등록 버튼 → generated_questions에 저장
   - 같은 지문+유형 = 덮어쓰기
        ↓
7️⃣ 완료
```

---

## 📊 핵심 정책

| 항목 | 정책 |
|------|------|
| 지문 수정 | 없음. 삭제 시 종속 문제 전체 삭제 |
| 재출제 | 덮어쓰기 (최신만 유지) |
| 필수필드 에러 | 검증 → 스킵 → 오류 문제 별도 관리 (향후) |
| 대량 생성 | 배치 처리 + 진행률 + 자동 재시도 |
| 부분 실패 | 실패 지문 선택/전체/스킵 옵션 |
| 부분 등록 | 성공한 것 중 선택 등록 가능 |
| 레이아웃 | 출력 시점에 최신 설정 적용 (데이터와 분리) |
| 페이지 이탈 | 경고 표시, 강제 닫힘 시 캐시 활용 |

---

## 🏗️ 개발 태스크

### Phase 1: 기본 UI 구조

#### Task 1.1: 문제출제 메인 화면
- **파일**: `src/components/features/generation/QuestionGeneration.tsx`
- **기능**:
  - 선택된 지문 목록 표시
  - 문제 유형 선택 드롭다운/카드
  - 출제시작 버튼
  - 진행 상태 표시 영역
- **예상 시간**: 2시간

#### Task 1.2: 문제 유형 선택 컴포넌트
- **파일**: `src/components/features/generation/QuestionTypeSelector.tsx`
- **기능**:
  - 활성화된 문제 유형 목록 표시
  - 카테고리별 그룹화 (수능형/내신-지문/내신-문장/자습서)
  - 선택 시 블록 정보 표시
- **예상 시간**: 1시간

---

### Phase 2: 생성 로직 개선

#### Task 2.1: 생성 API 개선 (`/api/generate`)
- **파일**: `src/app/api/generate/route.ts`
- **개선 사항**:
  - 필수 필드 검증 로직 추가
  - 자동 재시도 (최대 2회)
  - 에러 분류 (AI오류/네트워크/필드누락)
  - 덮어쓰기 로직 (기존 문제 업데이트)
- **예상 시간**: 2시간

#### Task 2.2: 필수 필드 검증 유틸
- **파일**: `src/lib/block-validator.ts`
- **기능**:
  ```typescript
  interface ValidationResult {
    valid: boolean
    errors: {
      field: string
      type: 'missing' | 'invalid_type' | 'invalid_value'
      message: string
    }[]
  }
  
  function validateBlockContent(
    content: Record<string, unknown>,
    blockDef: BlockDefinition
  ): ValidationResult
  ```
- **검증 항목**:
  - 필수 필드 존재 여부
  - choices 배열 길이 (5개)
  - answer 범위 (1~5)
  - 빈 문자열 체크
- **예상 시간**: 1시간

---

### Phase 3: 미리보기

#### Task 3.1: 미리보기 컴포넌트
- **파일**: `src/components/features/generation/GenerationPreview.tsx`
- **기능**:
  - 생성 결과 목록 (성공/실패 구분)
  - 지문별 펼치기/접기
  - 레이아웃 적용된 형태로 표시
  - 체크박스로 등록할 항목 선택
- **예상 시간**: 3시간

#### Task 3.2: 문제 렌더러 컴포넌트
- **파일**: `src/components/features/generation/QuestionRenderer.tsx`
- **기능**:
  - layout_config 기반 렌더링
  - 선택지 마커 적용 (①②③, ⓐⓑⓒ, 1.2.3.)
  - 뷰 모드 전환 (학생용/정답용/교사용)
- **예상 시간**: 2시간

---

### Phase 4: 진행 상태 및 에러 처리

#### Task 4.1: 진행 상태 컴포넌트
- **파일**: `src/components/features/generation/GenerationProgress.tsx`
- **기능**:
  - 프로그레스바 (N/M 완료)
  - 현재 처리 중인 지문 표시
  - 성공/실패/진행중 카운터
  - 예상 완료 시간
- **예상 시간**: 1시간

#### Task 4.2: 페이지 이탈 경고
- **기능**:
  - `beforeunload` 이벤트 핸들러
  - 생성 중일 때만 경고 표시
- **예상 시간**: 30분

#### Task 4.3: 실패 처리 UI
- **기능**:
  - 실패한 지문 목록 표시
  - 에러 유형별 아이콘/메시지
  - 재시도 버튼 (선택/전체)
  - 스킵하고 계속 옵션
- **예상 시간**: 1시간

---

### Phase 5: 등록 및 완료

#### Task 5.1: 등록 API
- **파일**: `src/app/api/generate/register/route.ts`
- **기능**:
  - 선택된 항목만 generated_questions에 저장
  - 덮어쓰기 로직 (upsert)
  - 등록 결과 반환
- **예상 시간**: 1시간

#### Task 5.2: 완료 화면
- **기능**:
  - 등록 완료 요약 (N개 등록)
  - 문제 관리로 이동 버튼
  - 출력물 생성으로 이동 버튼
- **예상 시간**: 30분

---

### Phase 6: 부가 기능

#### Task 6.1: 테스트 모드
- **기능**:
  - 1개 지문만 먼저 테스트
  - 결과 확인 후 전체 실행 옵션
- **예상 시간**: 1시간

#### Task 6.2: 블록 삭제 시 영향 확인
- **파일**: `src/app/api/block-definitions/[id]/route.ts` 수정
- **기능**:
  - DELETE 전 영향 범위 조회
  - 사용 중인 문제 유형 수
  - 생성된 문제 수
- **예상 시간**: 30분

---

## 📁 파일 구조

```
src/
├── app/
│   └── api/
│       └── generate/
│           ├── route.ts          # 생성 API (개선)
│           └── register/
│               └── route.ts      # 등록 API (신규)
├── components/
│   └── features/
│       └── generation/
│           ├── index.ts
│           ├── QuestionGeneration.tsx    # 메인 화면
│           ├── QuestionTypeSelector.tsx  # 유형 선택
│           ├── GenerationProgress.tsx    # 진행 상태
│           ├── GenerationPreview.tsx     # 미리보기
│           ├── QuestionRenderer.tsx      # 문제 렌더러
│           └── FailedItemsPanel.tsx      # 실패 처리
└── lib/
    └── block-validator.ts        # 검증 유틸
```

---

## 🗓️ 개발 일정 (예상)

| Phase | 태스크 | 예상 시간 |
|-------|--------|-----------|
| **Phase 1** | 기본 UI 구조 | 3시간 |
| **Phase 2** | 생성 로직 개선 | 3시간 |
| **Phase 3** | 미리보기 | 5시간 |
| **Phase 4** | 진행 상태/에러 | 2.5시간 |
| **Phase 5** | 등록/완료 | 1.5시간 |
| **Phase 6** | 부가 기능 | 1.5시간 |
| **총계** | | **16.5시간** |

---

## ✅ 체크리스트

### 필수 (1차)
- [ ] 문제출제 메인 화면
- [ ] 문제 유형 선택
- [ ] 생성 API 개선 (검증, 재시도)
- [ ] 진행 상태 표시
- [ ] 미리보기 (지문별)
- [ ] 부분 등록
- [ ] 덮어쓰기 로직
- [ ] 실패 처리 (재시도/스킵)
- [ ] 페이지 이탈 경고

### 권장 (2차)
- [ ] 테스트 모드 (1개 먼저)
- [ ] 블록 삭제 시 영향 확인
- [ ] 에러 분류 표시

### 향후
- [ ] 오류 문제 별도 관리
- [ ] 출제 이력/로그
- [ ] 출력물 생성 연계

---

## 📝 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-12-11 | 최초 작성 |

