import React, { useState } from 'react';

export default function AdminLayout() {
  const [activeTab, setActiveTab] = useState('êµì¬ê´€ë¦¬');
  const [settingMenu, setSettingMenu] = useState('ë°ì´í„° ìœ í˜•');
  
  // êµì¬ ê´€ë¦¬ ìƒíƒœ
  const [groups, setGroups] = useState([]);
  const [newGroupName, setNewGroupName] = useState('');
  const [expandedNodes, setExpandedNodes] = useState({});
  const [selectedGroup, setSelectedGroup] = useState(null);
  const [selectedTextbook, setSelectedTextbook] = useState(null);
  const [showMoveModal, setShowMoveModal] = useState(false);
  const [googleSheetUrl, setGoogleSheetUrl] = useState('');
  const [sheetInfo, setSheetInfo] = useState(null);
  const [selectedItems, setSelectedItems] = useState({});
  const [expandedUnits, setExpandedUnits] = useState({});
  
  // ë°ì´í„° ìœ í˜• ìƒíƒœ
  const [dataTypes, setDataTypes] = useState([]);
  const [selectedDataType, setSelectedDataType] = useState(null);
  const [isEditingDataType, setIsEditingDataType] = useState(false);
  const [dataTypeForm, setDataTypeForm] = useState({
    id: null,
    name: '',
    target: 'passage',
    prompt: '',
    variables: [],
    outputSchema: '',
    sampleResult: '',
    hasAnswer: false,
    answerFormat: '',
    hasDependency: false,
    dependsOn: []
  });

  // ë¬¸ì œ ìœ í˜• ìƒíƒœ
  const [questionTypes, setQuestionTypes] = useState([]);
  const [selectedQuestionType, setSelectedQuestionType] = useState(null);
  const [isEditingQuestionType, setIsEditingQuestionType] = useState(false);
  const [questionTypeForm, setQuestionTypeForm] = useState({
    id: null,
    name: '',
    instruction: '',
    dataTypeList: [],
    choiceLayout: 'vertical',
    choiceMarker: 'circle'
  });
  const [showDataTypeSelector, setShowDataTypeSelector] = useState(false);

  const tabs = ['íšŒì›ê´€ë¦¬', 'êµì¬ê´€ë¦¬', 'ì„¤ì •'];

  // ============ êµì¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ============
  
  const handleAddGroup = () => {
    if (newGroupName.trim()) {
      const newGroup = {
        id: Date.now(),
        name: newGroupName.trim(),
        type: 'group',
        children: []
      };
      setGroups([...groups, newGroup]);
      setNewGroupName('');
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') handleAddGroup();
  };

  const toggleNode = (nodeId, e) => {
    e.stopPropagation();
    setExpandedNodes(prev => ({ ...prev, [nodeId]: !prev[nodeId] }));
  };

  const handleSelectGroup = (group) => {
    setSelectedGroup(group);
    setSelectedTextbook(null);
    setShowMoveModal(false);
    setGoogleSheetUrl('');
    setSheetInfo(null);
    setSelectedItems({});
    setExpandedUnits({});
  };

  const handleSelectTextbook = (textbook, parentGroup) => {
    setSelectedTextbook({ ...textbook, parentGroupId: parentGroup.id, parentGroupName: parentGroup.name });
    setSelectedGroup(null);
    setShowMoveModal(false);
  };

  const handleMoveTextbook = (targetGroupId) => {
    if (!selectedTextbook || targetGroupId === selectedTextbook.parentGroupId) return;
    setGroups(prev => {
      const updated = prev.map(group => {
        if (group.id === selectedTextbook.parentGroupId) {
          return { ...group, children: group.children.filter(tb => tb.id !== selectedTextbook.id) };
        }
        return group;
      });
      return updated.map(group => {
        if (group.id === targetGroupId) {
          const { parentGroupId, parentGroupName, ...textbookData } = selectedTextbook;
          return { ...group, children: [...group.children, textbookData] };
        }
        return group;
      });
    });
    setExpandedNodes(prev => ({ ...prev, [targetGroupId]: true }));
    setShowMoveModal(false);
    setSelectedTextbook(null);
  };

  const handleDeleteTextbook = () => {
    if (!selectedTextbook) return;
    if (confirm(`"${selectedTextbook.name}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      setGroups(prev => prev.map(group => {
        if (group.id === selectedTextbook.parentGroupId) {
          return { ...group, children: group.children.filter(tb => tb.id !== selectedTextbook.id) };
        }
        return group;
      }));
      setSelectedTextbook(null);
    }
  };

  const handleFetchSheet = () => {
    if (googleSheetUrl.trim()) {
      const simulatedInfo = {
        fileName: 'ëŠ¥ë¥ ì˜ì–´ ê³ 1',
        units: [
          { name: 'Unit 1', passages: ['ì§€ë¬¸ 1', 'ì§€ë¬¸ 2', 'ì§€ë¬¸ 3'] },
          { name: 'Unit 2', passages: ['ì§€ë¬¸ 1', 'ì§€ë¬¸ 2'] },
          { name: 'Unit 3', passages: ['ì§€ë¬¸ 1', 'ì§€ë¬¸ 2', 'ì§€ë¬¸ 3', 'ì§€ë¬¸ 4'] },
          { name: 'Unit 4', passages: ['ì§€ë¬¸ 1', 'ì§€ë¬¸ 2'] },
          { name: 'Unit 5', passages: ['ì§€ë¬¸ 1', 'ì§€ë¬¸ 2', 'ì§€ë¬¸ 3'] },
        ]
      };
      setSheetInfo(simulatedInfo);
      setSelectedItems({});
      setExpandedUnits({});
    }
  };

  const toggleUnitExpand = (unitName) => {
    setExpandedUnits(prev => ({ ...prev, [unitName]: !prev[unitName] }));
  };

  const handleToggleUnit = (unit) => {
    const allPassages = unit.passages;
    const currentSelected = selectedItems[unit.name] || [];
    if (currentSelected.length === allPassages.length) {
      setSelectedItems(prev => { const newItems = { ...prev }; delete newItems[unit.name]; return newItems; });
    } else {
      setSelectedItems(prev => ({ ...prev, [unit.name]: [...allPassages] }));
    }
  };

  const handleTogglePassage = (unitName, passage) => {
    setSelectedItems(prev => {
      const currentSelected = prev[unitName] || [];
      const newSelected = currentSelected.includes(passage)
        ? currentSelected.filter(p => p !== passage)
        : [...currentSelected, passage];
      if (newSelected.length === 0) { const newItems = { ...prev }; delete newItems[unitName]; return newItems; }
      return { ...prev, [unitName]: newSelected };
    });
  };

  const handleToggleAllPassages = () => {
    const totalPassages = sheetInfo.units.reduce((sum, u) => sum + u.passages.length, 0);
    const selectedPassages = Object.values(selectedItems).reduce((sum, arr) => sum + arr.length, 0);
    if (selectedPassages === totalPassages) {
      setSelectedItems({});
    } else {
      const allSelected = {};
      sheetInfo.units.forEach(unit => { allSelected[unit.name] = [...unit.passages]; });
      setSelectedItems(allSelected);
    }
  };

  const getSelectedCount = () => Object.values(selectedItems).reduce((sum, arr) => sum + arr.length, 0);

  const handleRegisterTextbook = () => {
    if (selectedGroup && sheetInfo && getSelectedCount() > 0) {
      const newTextbook = {
        id: Date.now(),
        name: sheetInfo.fileName,
        type: 'textbook',
        children: Object.entries(selectedItems).map(([unitName, passages], idx) => ({
          id: Date.now() + idx + 1,
          name: unitName,
          type: 'unit',
          children: passages.map((passage, pIdx) => ({
            id: Date.now() + idx + 1 + pIdx + 100,
            name: passage,
            type: 'passage',
            children: []
          }))
        }))
      };
      setGroups(prev => prev.map(group => {
        if (group.id === selectedGroup.id) return { ...group, children: [...group.children, newTextbook] };
        return group;
      }));
      setGoogleSheetUrl('');
      setSheetInfo(null);
      setSelectedItems({});
      setExpandedUnits({});
      setExpandedNodes(prev => ({ ...prev, [selectedGroup.id]: true }));
    }
  };

  // ============ ë°ì´í„° ìœ í˜• í•¨ìˆ˜ë“¤ ============

  const resetDataTypeForm = () => {
    setDataTypeForm({
      id: null, name: '', target: 'passage', prompt: '', variables: [],
      outputSchema: '', sampleResult: '', hasAnswer: false, answerFormat: '',
      hasDependency: false, dependsOn: []
    });
    setIsEditingDataType(false);
    setSelectedDataType(null);
  };

  // ============ ë¬¸ì œ ìœ í˜• í•¨ìˆ˜ë“¤ ============

  const resetQuestionTypeForm = () => {
    setQuestionTypeForm({
      id: null, name: '', instruction: '', dataTypeList: [],
      choiceLayout: 'vertical', choiceMarker: 'circle'
    });
    setIsEditingQuestionType(false);
    setSelectedQuestionType(null);
    setShowDataTypeSelector(false);
  };

  const handleNewQuestionType = () => {
    resetQuestionTypeForm();
    setIsEditingQuestionType(true);
  };

  const handleSelectQuestionType = (qt) => {
    setSelectedQuestionType(qt);
    setQuestionTypeForm({ ...qt });
    setIsEditingQuestionType(false);
    setShowDataTypeSelector(false);
  };

  const handleEditQuestionType = () => {
    if (selectedQuestionType) setIsEditingQuestionType(true);
  };

  const handleSaveQuestionType = () => {
    if (!questionTypeForm.name.trim()) { alert('ë¬¸ì œ ìœ í˜•ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (questionTypeForm.id) {
      setQuestionTypes(prev => prev.map(qt => qt.id === questionTypeForm.id ? { ...questionTypeForm } : qt));
    } else {
      setQuestionTypes(prev => [...prev, { ...questionTypeForm, id: Date.now() }]);
    }
    resetQuestionTypeForm();
  };

  const handleDeleteQuestionType = () => {
    if (selectedQuestionType && confirm(`"${selectedQuestionType.name}" ë¬¸ì œ ìœ í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      setQuestionTypes(prev => prev.filter(qt => qt.id !== selectedQuestionType.id));
      resetQuestionTypeForm();
    }
  };

  const handleAddDataTypeToQuestion = (dataType) => {
    const newItem = {
      id: Date.now(),
      dataTypeId: dataType.id,
      dataTypeName: dataType.name,
      role: 'body'
    };
    setQuestionTypeForm(prev => ({
      ...prev,
      dataTypeList: [...prev.dataTypeList, newItem]
    }));
    setShowDataTypeSelector(false);
  };

  const handleRemoveDataTypeFromQuestion = (itemId) => {
    setQuestionTypeForm(prev => ({
      ...prev,
      dataTypeList: prev.dataTypeList.filter(item => item.id !== itemId)
    }));
  };

  const handleMoveDataType = (index, direction) => {
    const newList = [...questionTypeForm.dataTypeList];
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= newList.length) return;
    [newList[index], newList[newIndex]] = [newList[newIndex], newList[index]];
    setQuestionTypeForm(prev => ({ ...prev, dataTypeList: newList }));
  };

  const handleChangeDataTypeRole = (itemId, role) => {
    setQuestionTypeForm(prev => ({
      ...prev,
      dataTypeList: prev.dataTypeList.map(item => 
        item.id === itemId ? { ...item, role } : item
      )
    }));
  };

  // ì˜ì¡´ì„± ê²€ì¦
  const validateDependencies = () => {
    const warnings = [];
    const addedIds = [];
    
    questionTypeForm.dataTypeList.forEach((item, index) => {
      const dataType = dataTypes.find(dt => dt.id === item.dataTypeId);
      if (dataType?.hasDependency && dataType.dependsOn.length > 0) {
        dataType.dependsOn.forEach(depId => {
          const depIndex = questionTypeForm.dataTypeList.findIndex(i => i.dataTypeId === depId);
          if (depIndex === -1) {
            const depType = dataTypes.find(dt => dt.id === depId);
            warnings.push(`"${dataType.name}"ì€(ëŠ”) "${depType?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}"ì´(ê°€) í•„ìš”í•©ë‹ˆë‹¤.`);
          }
        });
      }
      addedIds.push(item.dataTypeId);
    });
    
    return warnings;
  };

  const handleNewDataType = () => {
    resetDataTypeForm();
    setIsEditingDataType(true);
  };

  const handleSelectDataType = (dataType) => {
    setSelectedDataType(dataType);
    setDataTypeForm({ 
      ...dataType,
      hasDependency: dataType.hasDependency || false,
      dependsOn: dataType.dependsOn || []
    });
    setIsEditingDataType(false);
  };

  const handleEditDataType = () => {
    if (selectedDataType) setIsEditingDataType(true);
  };

  const handleSaveDataType = () => {
    if (!dataTypeForm.name.trim()) { alert('ìœ í˜•ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (dataTypeForm.id) {
      setDataTypes(prev => prev.map(dt => dt.id === dataTypeForm.id ? { ...dataTypeForm } : dt));
    } else {
      setDataTypes(prev => [...prev, { ...dataTypeForm, id: Date.now() }]);
    }
    resetDataTypeForm();
  };

  const handleDeleteDataType = () => {
    if (selectedDataType && confirm(`"${selectedDataType.name}" ìœ í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      setDataTypes(prev => prev.filter(dt => dt.id !== selectedDataType.id));
      resetDataTypeForm();
    }
  };

  const extractVariables = (prompt) => {
    const matches = prompt.match(/\[\[([^\]]+)\]\]/g) || [];
    return matches.map(m => m.replace(/\[\[|\]\]/g, ''));
  };

  const handlePromptChange = (value) => {
    setDataTypeForm(prev => ({ ...prev, prompt: value, variables: extractVariables(value) }));
  };

  // ============ íŠ¸ë¦¬ ë Œë”ë§ ============

  const renderTreeNode = (node, depth = 0, parentGroup = null) => {
    const hasChildren = node.children && node.children.length > 0;
    const isExpanded = expandedNodes[node.id];
    const isSelectedGroup = selectedGroup?.id === node.id;
    const isSelectedTextbook = selectedTextbook?.id === node.id;
    
    const depthColors = { group: 'text-blue-600', textbook: 'text-green-600', unit: 'text-orange-500', passage: 'text-purple-600', sentence: 'text-gray-600' };
    const depthLabels = { group: 'ê·¸ë£¹', textbook: 'êµì¬', unit: 'ë‹¨ì›', passage: 'ì§€ë¬¸', sentence: 'ë¬¸ì¥' };

    const handleNodeClick = () => {
      if (node.type === 'group') handleSelectGroup(node);
      else if (node.type === 'textbook' && parentGroup) handleSelectTextbook(node, parentGroup);
    };

    return (
      <div key={node.id}>
        <div
          className={`flex items-center py-1.5 px-2 rounded cursor-pointer ${isSelectedGroup || isSelectedTextbook ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
          style={{ paddingLeft: `${depth * 16 + 8}px` }}
          onClick={handleNodeClick}
        >
          {hasChildren ? (
            <span className="w-4 h-4 mr-1 text-gray-400 text-xs flex items-center justify-center" onClick={(e) => toggleNode(node.id, e)}>
              {isExpanded ? 'â–¼' : 'â–¶'}
            </span>
          ) : <span className="w-4 h-4 mr-1" />}
          <span className={`text-sm ${depthColors[node.type]}`}>{node.name}</span>
          <span className="text-xs text-gray-400 ml-1">({depthLabels[node.type]})</span>
        </div>
        {isExpanded && hasChildren && (
          <div>{node.children.map(child => renderTreeNode(child, depth + 1, node.type === 'group' ? node : parentGroup))}</div>
        )}
      </div>
    );
  };

  // ============ ë Œë”ë§ ============

  return (
    <div className="h-screen flex bg-gray-100">
      {/* ì¢Œì¸¡ íŒ¨ë„ */}
      <div className="w-56 bg-white border-r border-gray-200 flex flex-col">
        <div className="flex border-b border-gray-200">
          {tabs.map((tab) => (
            <button
              key={tab}
              onClick={() => { setActiveTab(tab); resetDataTypeForm(); }}
              className={`flex-1 py-3 text-sm font-medium transition-colors ${
                activeTab === tab ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              }`}
            >
              {tab}
            </button>
          ))}
        </div>

        <div className="flex-1 p-3 overflow-auto">
          {activeTab === 'êµì¬ê´€ë¦¬' && (
            <div>
              <div className="flex gap-2 mb-3">
                <input type="text" value={newGroupName} onChange={(e) => setNewGroupName(e.target.value)} onKeyDown={handleKeyDown}
                  placeholder="ê·¸ë£¹ëª… ì…ë ¥" className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button onClick={handleAddGroup} className="px-3 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600">ë“±ë¡</button>
              </div>
              <div className="border border-gray-200 rounded-lg bg-gray-50">
                {groups.length === 0 ? (
                  <p className="py-4 text-center text-sm text-gray-500">ë“±ë¡ëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤</p>
                ) : (
                  <div className="py-2">{groups.map(group => renderTreeNode(group, 0))}</div>
                )}
              </div>
            </div>
          )}

          {activeTab === 'íšŒì›ê´€ë¦¬' && <p className="text-gray-500 text-sm">íšŒì›ê´€ë¦¬ ë©”ë‰´</p>}

          {activeTab === 'ì„¤ì •' && (
            <div>
              <div className="space-y-1 mb-3">
                {['ë°ì´í„° ìœ í˜•', 'ë¬¸ì œ ìœ í˜•', 'ì„¤ì •'].map((menu) => (
                  <button key={menu} onClick={() => { setSettingMenu(menu); resetDataTypeForm(); }}
                    className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
                      settingMenu === menu ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'
                    }`}>
                    {menu}
                  </button>
                ))}
              </div>

              {settingMenu === 'ë°ì´í„° ìœ í˜•' && (
                <div>
                  <button onClick={handleNewDataType} className="w-full py-2 px-3 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 mb-2">
                    + ë°ì´í„° ìœ í˜• ì¶”ê°€
                  </button>
                  <div className="border border-gray-200 rounded-lg bg-gray-50 max-h-80 overflow-auto">
                    {dataTypes.length === 0 ? (
                      <p className="py-4 text-center text-sm text-gray-500">ë“±ë¡ëœ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    ) : (
                      <div className="py-1">
                        {dataTypes.map(dt => (
                          <div key={dt.id} onClick={() => handleSelectDataType(dt)}
                            className={`px-3 py-2 cursor-pointer text-sm ${selectedDataType?.id === dt.id ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'}`}>
                            <div className="font-medium">{dt.name}</div>
                            <div className="text-xs text-gray-500">{dt.target === 'passage' ? 'ì§€ë¬¸' : 'ë¬¸ì¥'} â€¢ {dt.hasAnswer ? 'ì •ë‹µæœ‰' : 'ìë£Œí˜•'}</div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {settingMenu === 'ë¬¸ì œ ìœ í˜•' && (
                <div>
                  <button onClick={handleNewQuestionType} className="w-full py-2 px-3 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 mb-2">
                    + ë¬¸ì œ ìœ í˜• ì¶”ê°€
                  </button>
                  <div className="border border-gray-200 rounded-lg bg-gray-50 max-h-80 overflow-auto">
                    {questionTypes.length === 0 ? (
                      <p className="py-4 text-center text-sm text-gray-500">ë“±ë¡ëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    ) : (
                      <div className="py-1">
                        {questionTypes.map(qt => (
                          <div key={qt.id} onClick={() => handleSelectQuestionType(qt)}
                            className={`px-3 py-2 cursor-pointer text-sm ${selectedQuestionType?.id === qt.id ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'}`}>
                            <div className="font-medium">{qt.name}</div>
                            <div className="text-xs text-gray-500">{qt.dataTypeList.length}ê°œ ë°ì´í„° ìœ í˜• ì¡°í•©</div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {/* ì¤‘ì•™ íŒ¨ë„ */}
      <div className="flex-1 flex flex-col">
        <div className="h-14 bg-white border-b border-gray-200 flex items-center px-6">
          <h2 className="text-lg font-semibold text-gray-800">
            {activeTab === 'ì„¤ì •' ? `ì„¤ì • > ${settingMenu}` : activeTab}
          </h2>
        </div>
        <div className="flex-1 p-6 overflow-auto">
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 h-full p-6 overflow-auto">
            
            {/* êµì¬ê´€ë¦¬ - ê·¸ë£¹ ì„ íƒ ì‹œ */}
            {activeTab === 'êµì¬ê´€ë¦¬' && selectedGroup && (
              <div>
                <h3 className="text-lg font-semibold mb-4">ğŸ“ {selectedGroup.name} - êµì¬ ë“±ë¡</h3>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">êµ¬ê¸€ì‹œíŠ¸ URL</label>
                  <div className="flex gap-2">
                    <input type="text" value={googleSheetUrl} onChange={(e) => setGoogleSheetUrl(e.target.value)}
                      placeholder="https://docs.google.com/spreadsheets/d/..."
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button onClick={handleFetchSheet} className="px-4 py-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600">ì¡°íšŒ</button>
                  </div>
                </div>
                {sheetInfo && (
                  <div className="border border-gray-200 rounded-lg p-4">
                    <div className="mb-3">
                      <span className="text-sm text-gray-500">êµì¬ëª…:</span>
                      <span className="ml-2 font-semibold text-blue-600">{sheetInfo.fileName}</span>
                    </div>
                    <div className="mb-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium text-gray-700">ë‹¨ì›/ì§€ë¬¸ ì„ íƒ</span>
                        <button onClick={handleToggleAllPassages} className="text-sm text-blue-500 hover:text-blue-700">
                          {getSelectedCount() === sheetInfo.units.reduce((sum, u) => sum + u.passages.length, 0) ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}
                        </button>
                      </div>
                      <div className="space-y-1 max-h-64 overflow-auto border border-gray-100 rounded p-2 bg-gray-50">
                        {sheetInfo.units.map((unit) => {
                          const unitSelected = selectedItems[unit.name] || [];
                          const isAllSelected = unitSelected.length === unit.passages.length;
                          const isPartialSelected = unitSelected.length > 0 && unitSelected.length < unit.passages.length;
                          const isExpanded = expandedUnits[unit.name];
                          return (
                            <div key={unit.name} className="bg-white rounded border border-gray-200">
                              <div className="flex items-center gap-2 p-2 hover:bg-gray-50">
                                <span onClick={() => toggleUnitExpand(unit.name)} className="cursor-pointer text-gray-400 text-xs w-4">{isExpanded ? 'â–¼' : 'â–¶'}</span>
                                <input type="checkbox" checked={isAllSelected} ref={el => { if (el) el.indeterminate = isPartialSelected; }}
                                  onChange={() => handleToggleUnit(unit)} className="w-4 h-4 text-blue-500" />
                                <span className="text-sm font-medium cursor-pointer flex-1" onClick={() => toggleUnitExpand(unit.name)}>{unit.name}</span>
                                <span className="text-xs text-gray-400">{unitSelected.length}/{unit.passages.length}</span>
                              </div>
                              {isExpanded && (
                                <div className="border-t border-gray-100 bg-gray-50 p-2 pl-8 space-y-1">
                                  {unit.passages.map((passage) => (
                                    <label key={passage} className="flex items-center gap-2 cursor-pointer hover:bg-white p-1 rounded text-sm">
                                      <input type="checkbox" checked={unitSelected.includes(passage)} onChange={() => handleTogglePassage(unit.name, passage)} className="w-4 h-4 text-blue-500" />
                                      <span className="text-gray-600">{passage}</span>
                                    </label>
                                  ))}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    <button onClick={handleRegisterTextbook} disabled={getSelectedCount() === 0}
                      className={`w-full py-2 font-medium rounded-lg transition-colors ${getSelectedCount() > 0 ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                      êµì¬ ë“±ë¡ ({getSelectedCount()}ê°œ ì§€ë¬¸)
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* êµì¬ê´€ë¦¬ - êµì¬ ì„ íƒ ì‹œ */}
            {activeTab === 'êµì¬ê´€ë¦¬' && selectedTextbook && (
              <div>
                <h3 className="text-lg font-semibold mb-4">ğŸ“– {selectedTextbook.name}</h3>
                <div className="border border-gray-200 rounded-lg p-4 mb-4">
                  <div className="space-y-2 text-sm">
                    <div className="flex"><span className="text-gray-500 w-20">ì†Œì† ê·¸ë£¹:</span><span className="font-medium">{selectedTextbook.parentGroupName}</span></div>
                    <div className="flex"><span className="text-gray-500 w-20">ë‹¨ì› ìˆ˜:</span><span className="font-medium">{selectedTextbook.children?.length || 0}ê°œ</span></div>
                    <div className="flex"><span className="text-gray-500 w-20">ì§€ë¬¸ ìˆ˜:</span><span className="font-medium">{selectedTextbook.children?.reduce((sum, unit) => sum + (unit.children?.length || 0), 0) || 0}ê°œ</span></div>
                  </div>
                </div>
                <div className="border border-gray-200 rounded-lg p-4 mb-4">
                  <h4 className="text-sm font-medium text-gray-700 mb-2">ë‹¨ì› ëª©ë¡</h4>
                  <div className="space-y-1 max-h-40 overflow-auto">
                    {selectedTextbook.children?.map((unit) => (
                      <div key={unit.id} className="text-sm text-gray-600 py-1 px-2 bg-gray-50 rounded">{unit.name} ({unit.children?.length || 0}ê°œ ì§€ë¬¸)</div>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowMoveModal(true)} className="flex-1 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600">ê·¸ë£¹ ì´ë™</button>
                  <button onClick={handleDeleteTextbook} className="flex-1 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600">ì‚­ì œ</button>
                </div>
                {showMoveModal && (
                  <div className="mt-4 border border-blue-200 rounded-lg p-4 bg-blue-50">
                    <h4 className="text-sm font-medium text-gray-700 mb-3">ì´ë™í•  ê·¸ë£¹ ì„ íƒ</h4>
                    <div className="space-y-2 max-h-40 overflow-auto">
                      {groups.filter(g => g.id !== selectedTextbook.parentGroupId).map((group) => (
                        <button key={group.id} onClick={() => handleMoveTextbook(group.id)}
                          className="w-full text-left py-2 px-3 bg-white border border-gray-200 rounded-lg hover:bg-blue-100 hover:border-blue-300 text-sm">
                          ğŸ“ {group.name}
                        </button>
                      ))}
                      {groups.filter(g => g.id !== selectedTextbook.parentGroupId).length === 0 && (
                        <p className="text-sm text-gray-500 text-center py-2">ì´ë™ ê°€ëŠ¥í•œ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤</p>
                      )}
                    </div>
                    <button onClick={() => setShowMoveModal(false)} className="w-full mt-3 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                  </div>
                )}
              </div>
            )}

            {/* ì„¤ì • - ë°ì´í„° ìœ í˜• í¸ì§‘ */}
            {activeTab === 'ì„¤ì •' && settingMenu === 'ë°ì´í„° ìœ í˜•' && (isEditingDataType || selectedDataType) && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">
                  {isEditingDataType ? (dataTypeForm.id ? 'ë°ì´í„° ìœ í˜• ìˆ˜ì •' : 'ìƒˆ ë°ì´í„° ìœ í˜•') : 'ë°ì´í„° ìœ í˜• ìƒì„¸'}
                </h3>

                {/* ê¸°ë³¸ ì •ë³´ */}
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-semibold text-gray-700 mb-3">ê¸°ë³¸ ì •ë³´</h4>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">ìœ í˜•ëª… *</label>
                      <input type="text" value={dataTypeForm.name} onChange={(e) => setDataTypeForm(prev => ({ ...prev, name: e.target.value }))}
                        disabled={!isEditingDataType} placeholder="ì˜ˆ: ì£¼ì œë¬¸ ì°¾ê¸°"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">ëŒ€ìƒ</label>
                      <div className="flex gap-4">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="target" value="passage" checked={dataTypeForm.target === 'passage'}
                            onChange={(e) => setDataTypeForm(prev => ({ ...prev, target: e.target.value }))} disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                          <span className="text-sm">ì§€ë¬¸</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="target" value="sentence" checked={dataTypeForm.target === 'sentence'}
                            onChange={(e) => setDataTypeForm(prev => ({ ...prev, target: e.target.value }))} disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                          <span className="text-sm">ë¬¸ì¥</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                {/* í”„ë¡¬í”„íŠ¸ ì„¤ì • */}
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-semibold text-gray-700 mb-3">í”„ë¡¬í”„íŠ¸ ì„¤ì •</h4>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">í”„ë¡¬í”„íŠ¸ <span className="text-gray-400">(ë³€ìˆ˜: [[passage]], [[sentence]], [[korean]])</span></label>
                      <textarea value={dataTypeForm.prompt} onChange={(e) => handlePromptChange(e.target.value)} disabled={!isEditingDataType}
                        placeholder="ì˜ˆ: ë‹¤ìŒ ì§€ë¬¸ì—ì„œ ì£¼ì œë¬¸ì„ ì°¾ì•„ì£¼ì„¸ìš”.&#10;&#10;[[passage]]" rows={5}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono disabled:bg-gray-100" />
                    </div>
                    {dataTypeForm.variables.length > 0 && (
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">ì¶”ì¶œëœ ë³€ìˆ˜</label>
                        <div className="flex flex-wrap gap-2">
                          {dataTypeForm.variables.map((v, idx) => (
                            <span key={idx} className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">[[{v}]]</span>
                          ))}
                        </div>
                      </div>
                    )}
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">ì¶œë ¥ ìŠ¤í‚¤ë§ˆ (JSON)</label>
                      <textarea value={dataTypeForm.outputSchema} onChange={(e) => setDataTypeForm(prev => ({ ...prev, outputSchema: e.target.value }))}
                        disabled={!isEditingDataType} placeholder='ì˜ˆ: { "topic_sentence": "ë¬¸ì¥", "sentence_no": 1 }' rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono disabled:bg-gray-100" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">ê²°ê³¼ ìƒ˜í”Œ</label>
                      <textarea value={dataTypeForm.sampleResult} onChange={(e) => setDataTypeForm(prev => ({ ...prev, sampleResult: e.target.value }))}
                        disabled={!isEditingDataType} placeholder="AI ì¶œë ¥ ì˜ˆì‹œë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100" />
                    </div>
                  </div>
                </div>

                {/* ê²°ê³¼ ìœ í˜• */}
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-semibold text-gray-700 mb-3">ê²°ê³¼ ìœ í˜•</h4>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">ì •ë‹µ ìœ ë¬´</label>
                      <div className="flex gap-4">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="hasAnswer" checked={!dataTypeForm.hasAnswer}
                            onChange={() => setDataTypeForm(prev => ({ ...prev, hasAnswer: false, answerFormat: '' }))} disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                          <span className="text-sm">ì—†ìŒ (ìë£Œí˜•)</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="hasAnswer" checked={dataTypeForm.hasAnswer}
                            onChange={() => setDataTypeForm(prev => ({ ...prev, hasAnswer: true }))} disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                          <span className="text-sm">ìˆìŒ (ë¬¸ì œí˜•)</span>
                        </label>
                      </div>
                    </div>
                    {dataTypeForm.hasAnswer && (
                      <div>
                        <label className="block text-sm text-gray-600 mb-2">ì •ë‹µ í˜•ì‹</label>
                        <div className="grid grid-cols-2 gap-2">
                          {[
                            { value: '5choice', label: '5ì§€ì„ ë‹¤' },
                            { value: 'truefalse', label: 'ì–‘ìíƒì¼ (T/F)' },
                            { value: 'blank', label: 'ë¹ˆì¹¸ ì™„ì„±í˜•' },
                            { value: 'correction', label: 'ì§€ë¬¸ ìˆ˜ì •í˜•' },
                            { value: 'writing', label: 'ì˜ì‘í˜•' },
                            { value: 'ordering', label: 'ìˆœì„œ ë°°ì—´í˜•' },
                            { value: 'matching', label: 'ë§¤ì¹­í˜•' },
                            { value: 'descriptive', label: 'ì„œìˆ í˜•' },
                          ].map((format) => (
                            <label key={format.value}
                              className={`flex items-center gap-2 p-2 border rounded-lg cursor-pointer transition-colors ${
                                dataTypeForm.answerFormat === format.value ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'
                              } ${!isEditingDataType ? 'opacity-60' : ''}`}>
                              <input type="radio" name="answerFormat" value={format.value} checked={dataTypeForm.answerFormat === format.value}
                                onChange={(e) => setDataTypeForm(prev => ({ ...prev, answerFormat: e.target.value }))} disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                              <span className="text-sm">{format.label}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* ì˜ì¡´ì„± ì„¤ì • */}
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-semibold text-gray-700 mb-3">ì…ë ¥ ì˜ì¡´ì„±</h4>
                  <div className="space-y-3">
                    <div>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked={dataTypeForm.hasDependency}
                          onChange={(e) => setDataTypeForm(prev => ({ ...prev, hasDependency: e.target.checked, dependsOn: e.target.checked ? prev.dependsOn : [] }))}
                          disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                        <span className="text-sm">ë‹¤ë¥¸ ë°ì´í„° ìœ í˜•ì˜ ì¶œë ¥ì´ í•„ìš”í•¨</span>
                      </label>
                    </div>
                    {dataTypeForm.hasDependency && (
                      <div>
                        <label className="block text-sm text-gray-600 mb-2">í•„ìš”í•œ ë°ì´í„° ìœ í˜• ì„ íƒ</label>
                        <div className="space-y-1 max-h-32 overflow-auto border border-gray-100 rounded p-2 bg-gray-50">
                          {dataTypes.filter(dt => dt.id !== dataTypeForm.id).length === 0 ? (
                            <p className="text-xs text-gray-500 text-center py-2">ì„ íƒ ê°€ëŠ¥í•œ ë°ì´í„° ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</p>
                          ) : (
                            dataTypes.filter(dt => dt.id !== dataTypeForm.id).map(dt => (
                              <label key={dt.id} className="flex items-center gap-2 cursor-pointer p-1 hover:bg-white rounded">
                                <input type="checkbox" checked={dataTypeForm.dependsOn.includes(dt.id)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setDataTypeForm(prev => ({ ...prev, dependsOn: [...prev.dependsOn, dt.id] }));
                                    } else {
                                      setDataTypeForm(prev => ({ ...prev, dependsOn: prev.dependsOn.filter(id => id !== dt.id) }));
                                    }
                                  }}
                                  disabled={!isEditingDataType} className="w-4 h-4 text-blue-500" />
                                <span className="text-sm">{dt.name}</span>
                              </label>
                            ))
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* ì•¡ì…˜ ë²„íŠ¼ */}
                <div className="flex gap-2">
                  {isEditingDataType ? (
                    <>
                      <button onClick={handleSaveDataType} disabled={!dataTypeForm.name.trim()}
                        className={`flex-1 py-2 font-medium rounded-lg transition-colors ${dataTypeForm.name.trim() ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                        ì €ì¥
                      </button>
                      <button onClick={resetDataTypeForm} className="flex-1 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                    </>
                  ) : (
                    <>
                      <button onClick={handleEditDataType} className="flex-1 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600">ìˆ˜ì •</button>
                      <button onClick={handleDeleteDataType} className="flex-1 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600">ì‚­ì œ</button>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* ì„¤ì • - ë°ì´í„° ìœ í˜• ë¯¸ì„ íƒ ì‹œ */}
            {activeTab === 'ì„¤ì •' && settingMenu === 'ë°ì´í„° ìœ í˜•' && !isEditingDataType && !selectedDataType && (
              <p className="text-gray-500 text-center mt-20">ì¢Œì¸¡ì—ì„œ ë°ì´í„° ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”</p>
            )}

            {/* ì„¤ì • - ë¬¸ì œ ìœ í˜• í¸ì§‘ */}
            {activeTab === 'ì„¤ì •' && settingMenu === 'ë¬¸ì œ ìœ í˜•' && (isEditingQuestionType || selectedQuestionType) && (
              <div className="flex gap-4 h-full">
                {/* A4 ìº”ë²„ìŠ¤ ì˜ì—­ */}
                <div className="flex-1 flex flex-col">
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ ìœ í˜•ëª… *</label>
                    <input type="text" value={questionTypeForm.name} onChange={(e) => setQuestionTypeForm(prev => ({ ...prev, name: e.target.value }))}
                      disabled={!isEditingQuestionType} placeholder="ì˜ˆ: ë¹ˆì¹¸ ì¶”ë¡ "
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100" />
                  </div>

                  {/* A4 ìº”ë²„ìŠ¤ */}
                  <div className="flex-1 border-2 border-gray-300 rounded-lg bg-white p-4 overflow-auto" style={{ minHeight: '500px' }}>
                    <div className="border border-dashed border-gray-300 rounded p-3 mb-3 bg-gray-50">
                      <label className="block text-xs text-gray-500 mb-1">ì§€ì‹œë¬¸</label>
                      <input type="text" value={questionTypeForm.instruction}
                        onChange={(e) => setQuestionTypeForm(prev => ({ ...prev, instruction: e.target.value }))}
                        disabled={!isEditingQuestionType}
                        placeholder="ì˜ˆ: ë‹¤ìŒ ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ ë§ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?"
                        className="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100" />
                    </div>

                    {/* ë°ì´í„° ìœ í˜• ë°°ì¹˜ ëª©ë¡ */}
                    <div className="space-y-2">
                      {questionTypeForm.dataTypeList.length === 0 ? (
                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center text-gray-400">
                          <p className="mb-2">ë°ì´í„° ìœ í˜•ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                          <p className="text-xs">ìš°ì¸¡ íŒ¨ë„ì—ì„œ ë°ì´í„° ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜</p>
                          <p className="text-xs">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                        </div>
                      ) : (
                        questionTypeForm.dataTypeList.map((item, index) => {
                          const dataType = dataTypes.find(dt => dt.id === item.dataTypeId);
                          const hasMissingDep = dataType?.hasDependency && dataType.dependsOn.some(depId => 
                            !questionTypeForm.dataTypeList.some(i => i.dataTypeId === depId)
                          );
                          return (
                            <div key={item.id} className={`border rounded-lg p-3 ${hasMissingDep ? 'border-orange-400 bg-orange-50' : 'border-gray-200 bg-white'}`}>
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                  <span className="text-sm font-medium text-gray-700">{index + 1}.</span>
                                  <span className="text-sm font-semibold text-blue-600">{item.dataTypeName}</span>
                                  {hasMissingDep && (
                                    <span className="text-xs text-orange-600 bg-orange-100 px-2 py-0.5 rounded">âš ï¸ ì˜ì¡´ì„± í•„ìš”</span>
                                  )}
                                </div>
                                {isEditingQuestionType && (
                                  <div className="flex items-center gap-1">
                                    <button onClick={() => handleMoveDataType(index, -1)} disabled={index === 0}
                                      className="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-30">â†‘</button>
                                    <button onClick={() => handleMoveDataType(index, 1)} disabled={index === questionTypeForm.dataTypeList.length - 1}
                                      className="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-30">â†“</button>
                                    <button onClick={() => handleRemoveDataTypeFromQuestion(item.id)}
                                      className="px-2 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200">âœ•</button>
                                  </div>
                                )}
                              </div>
                              <div className="mt-2 flex items-center gap-2">
                                <span className="text-xs text-gray-500">ì—­í• :</span>
                                <select value={item.role} onChange={(e) => handleChangeDataTypeRole(item.id, e.target.value)}
                                  disabled={!isEditingQuestionType}
                                  className="text-xs border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100">
                                  <option value="body">ë³¸ë¬¸</option>
                                  <option value="choices">ì„ íƒì§€</option>
                                  <option value="answer">ì •ë‹µ</option>
                                  <option value="explanation">í•´ì„¤</option>
                                </select>
                              </div>
                            </div>
                          );
                        })
                      )}
                    </div>

                    {isEditingQuestionType && (
                      <button onClick={() => setShowDataTypeSelector(true)}
                        className="w-full mt-3 py-2 border-2 border-dashed border-blue-300 text-blue-500 rounded-lg hover:bg-blue-50 text-sm">
                        + ë°ì´í„° ìœ í˜• ì¶”ê°€
                      </button>
                    )}
                  </div>

                  {/* ì˜ì¡´ì„± ê²½ê³  */}
                  {validateDependencies().length > 0 && (
                    <div className="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                      <p className="text-sm font-medium text-orange-700 mb-1">âš ï¸ ì˜ì¡´ì„± ê²½ê³ </p>
                      <ul className="text-xs text-orange-600 space-y-1">
                        {validateDependencies().map((warning, idx) => (
                          <li key={idx}>â€¢ {warning}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* ì•¡ì…˜ ë²„íŠ¼ */}
                  <div className="flex gap-2 mt-4">
                    {isEditingQuestionType ? (
                      <>
                        <button onClick={handleSaveQuestionType} disabled={!questionTypeForm.name.trim()}
                          className={`flex-1 py-2 font-medium rounded-lg transition-colors ${questionTypeForm.name.trim() ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                          ì €ì¥
                        </button>
                        <button onClick={resetQuestionTypeForm} className="flex-1 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                      </>
                    ) : (
                      <>
                        <button onClick={handleEditQuestionType} className="flex-1 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600">ìˆ˜ì •</button>
                        <button onClick={handleDeleteQuestionType} className="flex-1 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600">ì‚­ì œ</button>
                      </>
                    )}
                  </div>
                </div>

                {/* ë°ì´í„° ìœ í˜• ì„ íƒ íŒ¨ë„ */}
                {showDataTypeSelector && (
                  <div className="w-64 border border-gray-200 rounded-lg bg-gray-50 p-3">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-semibold text-gray-700">ë°ì´í„° ìœ í˜• ì„ íƒ</h4>
                      <button onClick={() => setShowDataTypeSelector(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div className="space-y-1 max-h-96 overflow-auto">
                      {dataTypes.length === 0 ? (
                        <p className="text-xs text-gray-500 text-center py-4">ë“±ë¡ëœ ë°ì´í„° ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</p>
                      ) : (
                        dataTypes.map(dt => (
                          <button key={dt.id} onClick={() => handleAddDataTypeToQuestion(dt)}
                            className="w-full text-left p-2 bg-white border border-gray-200 rounded hover:bg-blue-50 hover:border-blue-300 transition-colors">
                            <div className="text-sm font-medium">{dt.name}</div>
                            <div className="text-xs text-gray-500">{dt.target === 'passage' ? 'ì§€ë¬¸' : 'ë¬¸ì¥'} â€¢ {dt.hasAnswer ? 'ì •ë‹µæœ‰' : 'ìë£Œí˜•'}</div>
                          </button>
                        ))
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ì„¤ì • - ë¬¸ì œ ìœ í˜• ë¯¸ì„ íƒ ì‹œ */}
            {activeTab === 'ì„¤ì •' && settingMenu === 'ë¬¸ì œ ìœ í˜•' && !isEditingQuestionType && !selectedQuestionType && (
              <p className="text-gray-500 text-center mt-20">ì¢Œì¸¡ì—ì„œ ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”</p>
            )}

            {/* ì„¤ì • - ì„¤ì • */}
            {activeTab === 'ì„¤ì •' && settingMenu === 'ì„¤ì •' && (
              <p className="text-gray-500 text-center mt-20">ì‹œìŠ¤í…œ ì„¤ì • ì˜ì—­</p>
            )}

            {/* êµì¬ê´€ë¦¬ - ë¯¸ì„ íƒ ì‹œ */}
            {activeTab === 'êµì¬ê´€ë¦¬' && !selectedGroup && !selectedTextbook && (
              <p className="text-gray-500 text-center mt-20">ì¢Œì¸¡ì—ì„œ ê·¸ë£¹ ë˜ëŠ” êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            )}

            {/* íšŒì›ê´€ë¦¬ */}
            {activeTab === 'íšŒì›ê´€ë¦¬' && (
              <p className="text-gray-500 text-center mt-20">íšŒì›ê´€ë¦¬ ì‹¤í–‰ ì˜ì—­</p>
            )}
          </div>
        </div>
      </div>

      {/* ìš°ì¸¡ íŒ¨ë„ */}
      <div className="w-72 bg-white border-l border-gray-200 flex flex-col">
        <div className="h-14 border-b border-gray-200 flex items-center px-4">
          <h3 className="font-semibold text-gray-800">
            {activeTab === 'ì„¤ì •' && settingMenu === 'ë¬¸ì œ ìœ í˜•' && (isEditingQuestionType || selectedQuestionType) 
              ? 'ë ˆì´ì•„ì›ƒ ì˜µì…˜' 
              : 'í™•ì¥ ê¸°ëŠ¥'}
          </h3>
        </div>
        <div className="flex-1 p-4 overflow-auto">
          {activeTab === 'ì„¤ì •' && settingMenu === 'ë¬¸ì œ ìœ í˜•' && (isEditingQuestionType || selectedQuestionType) ? (
            <div className="space-y-4">
              {/* ì„ íƒì§€ ë°°ì—´ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">ì„ íƒì§€ ë°°ì—´</label>
                <div className="space-y-2">
                  {[
                    { value: 'vertical', label: 'ì„¸ë¡œí˜•' },
                    { value: 'horizontal', label: 'ê°€ë¡œí˜•' },
                    { value: 'grid2', label: '2ì—´ ê·¸ë¦¬ë“œ' },
                  ].map(opt => (
                    <label key={opt.value} className={`flex items-center gap-2 p-2 border rounded-lg cursor-pointer transition-colors ${
                      questionTypeForm.choiceLayout === opt.value ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'
                    }`}>
                      <input type="radio" name="choiceLayout" value={opt.value}
                        checked={questionTypeForm.choiceLayout === opt.value}
                        onChange={(e) => setQuestionTypeForm(prev => ({ ...prev, choiceLayout: e.target.value }))}
                        disabled={!isEditingQuestionType} className="w-4 h-4 text-blue-500" />
                      <span className="text-sm">{opt.label}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* ì„ íƒì§€ ë²ˆí˜¸ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">ì„ íƒì§€ ë²ˆí˜¸</label>
                <div className="space-y-2">
                  {[
                    { value: 'circle', label: 'â‘  â‘¡ â‘¢ â‘£ â‘¤' },
                    { value: 'number', label: '1. 2. 3. 4. 5.' },
                    { value: 'alpha', label: 'A. B. C. D. E.' },
                    { value: 'paren', label: '(1) (2) (3) (4) (5)' },
                  ].map(opt => (
                    <label key={opt.value} className={`flex items-center gap-2 p-2 border rounded-lg cursor-pointer transition-colors ${
                      questionTypeForm.choiceMarker === opt.value ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'
                    }`}>
                      <input type="radio" name="choiceMarker" value={opt.value}
                        checked={questionTypeForm.choiceMarker === opt.value}
                        onChange={(e) => setQuestionTypeForm(prev => ({ ...prev, choiceMarker: e.target.value }))}
                        disabled={!isEditingQuestionType} className="w-4 h-4 text-blue-500" />
                      <span className="text-sm">{opt.label}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* ì¶œë ¥ë¬¼ ë¯¸ë¦¬ë³´ê¸° */}
              <div className="border-t pt-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">ì¶œë ¥ë¬¼ êµ¬ì„±</label>
                <div className="text-xs text-gray-500 space-y-1 bg-gray-50 p-3 rounded">
                  <p>ğŸ“„ ë¬¸ì œì§€.pdf (ë¬¸ì œë§Œ)</p>
                  <p>ğŸ“„ ì •ë‹µì§€.pdf (ì •ë‹µë§Œ)</p>
                  <p>ğŸ“„ í•´ì„¤ì§€.pdf (ì •ë‹µ+í•´ì„¤)</p>
                </div>
              </div>
            </div>
          ) : (
            <p className="text-gray-500 text-sm">í˜„ì¬ ì‘ì—…ê³¼ ê´€ë ¨ëœ í™•ì¥ ê¸°ëŠ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          )}
        </div>
      </div>
    </div>
  );
}