# 📋 문제출제 시스템 개발 플랜

> 최종 업데이트: 2024-12-04

---

## 🎯 시스템 전체 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              전체 시스템 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [DEFINE: 설정/정의 계층] ─────────────────────────────────────────────────  │
│                                                                             │
│   📝 프롬프트 관리 ──────→ 📊 데이터 유형 정의 ──────→ 📋 문제 유형 정의       │
│   (지시문+테스트+확정)     (프롬프트 연결+스키마)      (데이터유형 조합)        │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────   │
│                                                                             │
│   [EXECUTE: 실행/생성 계층] ────────────────────────────────────────────────  │
│                                                                             │
│   📚 교재 관리 ──→ ✂️ 문장분리 ──→ 🔮 데이터 생성 ──→ 📄 문제 생성           │
│   (지문 등록)      (AI 처리)      (AI 처리)        (조합+출력)              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📌 핵심 개념 구분

### "정의(Define)" vs "생성(Generate)"

| 구분 | 정의 (Define) | 생성 (Generate) |
|------|--------------|-----------------|
| **목적** | 템플릿/규칙 설정 | 실제 데이터 생산 |
| **AI 호출** | ❌ 없음 (테스트 제외) | ✅ 실제 호출 |
| **결과물** | 설정값 저장 | 콘텐츠 저장 |
| **빈도** | 한 번 설정 | 반복 실행 |

### 예시로 이해하기

```
📊 데이터 유형 "정의"
   └─ "주제문 찾기"라는 유형을 만들고 스키마 설정
   └─ 아직 실제 주제문은 없음

🔮 데이터 "생성"  
   └─ 지문 A에 "주제문 찾기" 적용 → { sentence_no: 1, topic: "..." }
   └─ 지문 B에 "주제문 찾기" 적용 → { sentence_no: 3, topic: "..." }
   └─ 실제 주제문 데이터가 만들어짐

📋 문제 유형 "정의"
   └─ "주제문 5지선다"라는 유형을 만들고 데이터 유형들 조합
   └─ 아직 실제 문제는 없음

📄 문제 "생성"
   └─ 지문 A의 생성된 데이터들을 "주제문 5지선다" 유형으로 조합
   └─ 실제 문제지가 만들어짐
```

---

## 🏗️ Phase 1: 설정/정의 계층 (DEFINE)

### 1.1 프롬프트 관리 ✅ 완료

> AI에게 "무엇을 어떻게 할지" 지시하는 템플릿

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 프롬프트 작성 | ✅ | content 필드에 지시문 작성 |
| AI 테스트 | ✅ | 다양한 지문으로 테스트 |
| 상태 관리 | ✅ | 초안 → 테스트 → 확정 |
| 테스트 히스토리 | ✅ | 이전 테스트 결과 저장 |

**핵심 원칙:**
- 프롬프트는 "마스터" (Single Source of Truth)
- 수정 시 연결된 모든 데이터 유형에 자동 반영
- 확정(confirmed) 상태만 데이터 유형에서 사용 권장

---

### 1.2 데이터 유형 정의 ✅ 완료

> 프롬프트를 연결하고, 결과의 "형식(스키마)"을 정의

| 태스크 | 상태 | 설명 |
|--------|------|------|
| - [x] 1.2.1 직접 입력 모드 제거 | ✅ | `promptInputMode === 'direct'` 관련 코드 삭제 |
| - [x] 1.2.2 테스트 패널 제거 | ✅ | 프롬프트에서 테스트하므로 불필요 |
| - [x] 1.2.3 불필요한 상태 제거 | ✅ | testSampleInput, isTesting 등 |
| - [x] 1.2.4 confirmed 프롬프트만 선택 | ✅ | 미확정 선택 시 경고 표시 |
| - [x] 1.2.5 프롬프트 미리보기 강화 | ✅ | 출력 스키마 미리보기 추가 |

**변경 사항 (2024-12-04):**
- 1,249줄 → 574줄 (54% 코드 감소)
- 직접 입력 모드 완전 제거
- 테스트 패널 완전 제거
- 프롬프트 필수 선택 (저장 버튼 비활성화)
- 미확정 프롬프트 선택 시 경고 표시
- 출력 스키마 미리보기 추가

**핵심 원칙:**
- 프롬프트는 라이브러리에서 선택만 (직접 작성 안 함)
- `output_schema`로 결과 형식 정의 (정형화 담당)
- 난이도 → 추천 모델 자동 선택

---

### 1.3 문제 유형 정의 ✅ 완료

> 여러 데이터 유형을 조합하고 역할을 부여

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 데이터 유형 조합 | ✅ | 여러 데이터 유형 추가 가능 |
| 역할 부여 | ✅ | body, choices, answer, explanation |
| 의존성 검증 | ✅ | 필요한 데이터 유형 누락 경고 |
| 레이아웃 설정 | ✅ | 선택지 배열, 마커 등 |

**핵심 원칙:**
- 데이터 유형의 "조합 규칙" 정의
- 실제 문제는 아직 없음 (템플릿만)

---

## 🚀 Phase 2: 실행/생성 계층 (EXECUTE)

### 2.1 교재 관리 & 문장분리 ✅ 완료

> 지문 등록 및 문장 단위 분리

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 구글시트 임포트 | ✅ | URL로 지문 가져오기 |
| 지문 선택 UI | ✅ | 체크박스, 확장/축소 |
| AI 문장분리 | ✅ | 영어/한글 병렬 매칭 |
| 배치 처리 | ✅ | BATCH_SIZE=10 병렬 |
| 결과 저장/복구 | ✅ | localStorage + DB |

**핵심 원칙:**
- 데이터 생성의 "레퍼런스" 구현
- 같은 UX 패턴 재사용 예정

---

### 2.2 데이터 생성 ✅ 구현 완료

> 지문에 데이터 유형을 적용하여 정형화된 데이터 생성

```
입력: 지문 + 데이터 유형
      ↓
처리: 프롬프트 content + output_schema + 지문 → AI 호출
      ↓
출력: generated_data 테이블에 JSON 저장
```

| 태스크 | 우선순위 | 상태 | 설명 |
|--------|---------|------|------|
| - [x] 2.2.1 DB 테이블 생성 | ✅ | | `generated_data` 테이블 + 인덱스 + RLS |
| - [x] 2.2.2 API 엔드포인트 | ✅ | | `/api/generate-data` (POST/GET) |
| - [x] 2.2.3 Context 생성 | ✅ | | `DataGenerateContext.tsx` (배치처리, localStorage) |
| - [x] 2.2.4 선택 UI | ✅ | | 지문 선택 (체크박스, 트리 구조) |
| - [x] 2.2.5 데이터 유형 선택 UI | ✅ | | 드롭다운 + 난이도 표시 |
| - [x] 2.2.6 실행/진행 상태 | ✅ | | 배치 처리, 프로그레스 바 |
| - [x] 2.2.7 결과 조회 UI | ✅ | | 생성된 데이터 목록/상세 (우측 패널) |
| - [x] 2.2.8 재생성 기능 | ✅ | | 특정 지문 재처리 버튼 |
| - [x] 2.2.9 UI 통합 | ✅ | | 교재관리 > 서브 탭 (문장분리/데이터 생성/문제 생성) |

**구현된 파일들:**
- `supabase/migrations/add_generated_data_table.sql`
- `src/app/api/generate-data/route.ts`
- `src/contexts/DataGenerateContext.tsx`
- `src/components/features/data-generate/DataGenerator.tsx`
- `src/components/features/data-generate/DataGeneratePanel.tsx`
- `src/components/layout/MainContent.tsx` (서브 탭 추가)

**DB 스키마:**
```sql
CREATE TABLE generated_data (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  passage_id UUID REFERENCES passages(id) ON DELETE CASCADE,
  data_type_id UUID REFERENCES data_types(id) ON DELETE CASCADE,
  result JSONB NOT NULL,
  model_used VARCHAR(50),
  confidence DECIMAL(3,2),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(passage_id, data_type_id)
);
```

---

### 2.3 문제 생성 ✅ 완료 (원큐 시스템)

> 생성된 데이터를 문제 유형에 맞게 조합하여 최종 문제 출력

```
입력: 지문 선택 (트리에서 교재/단원/지문 단위) + 문제 유형
      ↓
검증: 자동 사전 검증 (문장분리 완료 + 필요 데이터 확인)
      ↓
생성: 미리보기 모드로 생성 → 선택적 저장
      ↓
출력: generated_questions 테이블에 저장
```

| 태스크 | 우선순위 | 상태 | 설명 |
|--------|---------|------|------|
| - [x] 2.3.1 문제 조합 로직 | ✅ | | 역할별 데이터 매핑 (question_type_items) |
| - [x] 2.3.2 문제 미리보기 UI | ✅ | | 생성 전 미리보기 + 선택적 저장 |
| - [x] 2.3.3 문제 저장 (선택) | ✅ | | `generated_questions` 테이블 |
| - [x] 2.3.4 자동 사전 검증 | ✅ | | 문제 유형 선택 시 실시간 검증 |
| - [x] 2.3.5 지문 단위 선택 | ✅ | | 교재/단원/지문 계층 선택 |
| - [ ] 2.3.6 PDF 생성 | 🟢 | | 문제지/정답지/해설지 |
| - [ ] 2.3.7 일괄 출력 | 🟢 | | 여러 문제 한 번에 출력 |

**구현된 파일들:**
- `src/components/features/status-dashboard/OneClickGeneration.tsx`
- `src/app/api/generate-questions/route.ts`
- `src/app/api/generate-questions/validate/route.ts`

---

### 2.4 문제 관리 ✅ 완료

> 생성된 데이터/문제의 조회, 필터링, 삭제

| 태스크 | 우선순위 | 상태 | 설명 |
|--------|---------|------|------|
| - [x] 2.4.1 문제관리 탭 분리 | ✅ | | 현황/문장분리/문제출제/문제관리 4탭 구조 |
| - [x] 2.4.2 교재 트리 연동 | ✅ | | 좌측 트리에서 교재 선택 → 필터 연동 |
| - [x] 2.4.3 필터 기능 | ✅ | | 데이터유형/문제유형/상태별 필터 |
| - [x] 2.4.4 체크박스 삭제 | ✅ | | 전체삭제 / 유형별 삭제 |
| - [x] 2.4.5 계층적 삭제 | ✅ | | 지문 > 문제 > 데이터 종속 삭제 |

**구현된 파일들:**
- `src/components/features/status-dashboard/StatusDashboard.tsx`
- `src/components/features/status-dashboard/ManageFilterPanel.tsx`
- `src/app/api/passages/batch-delete-generated/route.ts`
- `src/app/api/passages/[id]/generated/by-question-type/route.ts`

---

## 📅 개발 순서 (권장)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 1: 데이터 유형 정의 정리 (Phase 1.2) ✅ 완료                        │
│  ══════════════════════════════════════════════════════════════════     │
│  • 직접 입력/테스트 패널 제거 ✅                                          │
│  • confirmed 프롬프트만 선택 ✅                                          │
│  소요 시간: ~30분                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  Step 2: 데이터 생성 구현 (Phase 2.2) ✅ 완료                             │
│  ══════════════════════════════════════                                 │
│  • DB 테이블 + API ✅                                                    │
│  • Context + UI ✅                                                       │
│  • 교재관리 서브 탭 통합 ✅                                               │
│  소요 시간: ~2시간                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  Step 3: 문제 생성 구현 (Phase 2.3) ✅ 완료                               │
│  ══════════════════════════════════════                                 │
│  • 원큐 문제 생성 시스템 ✅                                               │
│  • 자동 사전 검증 ✅                                                      │
│  • 미리보기 + 선택적 저장 ✅                                              │
│  • 지문 단위 선택 (교재/단원/지문) ✅                                     │
│  소요 시간: ~3일                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│  Step 4: 문제 관리 구현 (Phase 2.4) ✅ 완료                               │
│  ══════════════════════════════════════                                 │
│  • 문제관리 탭 분리 ✅                                                    │
│  • 필터 기반 조회/삭제 ✅                                                 │
│  • 계층적 삭제 (지문>문제>데이터) ✅                                      │
│  소요 시간: ~1일                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│  Step 5: PDF 출력 구현 (Phase 2.5) ⬅️ 다음 단계                          │
│  ══════════════════════════════════════                                 │
│  • 문제지/정답지/해설지 PDF 생성                                          │
│  예상 시간: 2-3일                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 💡 핵심 설계 원칙

| 원칙 | 설명 |
|------|------|
| **프롬프트 = 마스터** | 모든 AI 지시의 원천, 수정 시 연결된 모든 곳에 반영 |
| **데이터 유형 = 정형화** | output_schema로 결과 형식 정의 |
| **문제 유형 = 조합 규칙** | 데이터 유형들의 역할과 배치 정의 |
| **문장분리 UX = 레퍼런스** | 데이터 생성에 80% 이상 재사용 |
| **confirmed만 사용** | 확정된 프롬프트만 데이터 유형에서 선택 |

---

## 📊 진행 상황 요약

| Phase | 이름 | 상태 | 진행률 |
|-------|------|------|--------|
| 1.1 | 프롬프트 관리 | ✅ 완료 | 100% |
| 1.2 | 데이터 유형 정의 | ✅ 완료 | 100% |
| 1.3 | 문제 유형 정의 | ✅ 완료 | 100% |
| 2.1 | 교재 관리 & 문장분리 | ✅ 완료 | 100% |
| 2.2 | 데이터 생성 | ✅ 완료 | 100% |
| 2.3 | 문제 생성 (원큐 시스템) | ✅ 완료 | 100% |
| 2.4 | 문제 관리 | ✅ 완료 | 100% |
| 2.5 | PDF 출력 | 🆕 다음 단계 | 0% |

---

## 🔖 버전 히스토리

| 버전 | 날짜 | 내용 |
|------|------|------|
| 1.0 | 2024-12-04 | 초기 플랜 작성 |
| 1.1 | 2024-12-04 | Phase 1.2 완료 (DataTypeForm 정리) |
| 1.2 | 2024-12-04 | Phase 2.2 완료 (데이터 생성 기능 구현) |
| 2.0 | 2024-12-05 | Phase 2.3 완료 (원큐 문제 생성 시스템) |
| 2.1 | 2024-12-05 | Phase 2.4 완료 (문제 관리 탭, 필터/삭제 기능) |
| 2.2 | 2024-12-05 | 자동 사전 검증, 미리보기 모드, 선택적 저장 |
| 2.3 | 2024-12-05 | 지문 단위 선택 기능 (교재/단원/지문 계층 선택) |
